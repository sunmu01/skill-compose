# ==============================================================================
# Skills API - Docker Compose Configuration
# ==============================================================================
# Quick Start:
#   cd docker
#   cp .env.example .env
#   # Edit .env with your API keys
#   docker compose up -d
#
# Access:
#   - Web UI: http://localhost:626
#   - API: http://localhost:8766
#   - API Docs: http://localhost:8766/docs
#   - Documentation: http://localhost:3001
#
# With Nginx (production):
#   docker compose --profile nginx up -d
#   - Access: http://localhost (or your domain)
# ==============================================================================

name: skills-api

services:
  # ============================================================================
  # Database Service - PostgreSQL + pgvector
  # ============================================================================
  db:
    image: pgvector/pgvector:pg16  # PostgreSQL 16 with pgvector extension pre-installed
    container_name: skills-db
    restart: unless-stopped
    environment:
      - POSTGRES_USER=${DB_USER:-skills}
      - POSTGRES_PASSWORD=${DB_PASSWORD:-skills123}
      - POSTGRES_DB=${DB_NAME:-skills_api}
    volumes:
      - ${DB_DATA_PATH:-./volumes/db}:/var/lib/postgresql/data
    ports:
      - "${DB_PORT:-5432}:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${DB_USER:-skills} -d ${DB_NAME:-skills_api}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    networks:
      - skills-network

  # ============================================================================
  # API Service - FastAPI Backend
  # ============================================================================
  api:
    build:
      context: ..
      dockerfile: docker/api/Dockerfile
    image: skills-api:latest
    container_name: skills-api
    restart: unless-stopped
    environment:
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - GITHUB_TOKEN=${GITHUB_TOKEN:-}
      - GEMINI_API_KEY=${GEMINI_API_KEY:-}
      - UNSTRUCTURED_API_KEY=${UNSTRUCTURED_API_KEY:-}
      - RAGFLOW_API_KEY=${RAGFLOW_API_KEY:-}
      - RAGFLOW_BASE_URL=${RAGFLOW_BASE_URL:-}
      # Multi-LLM Provider API Keys
      - GOOGLE_API_KEY=${GOOGLE_API_KEY:-}
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - OPENROUTER_API_KEY=${OPENROUTER_API_KEY:-}
      - DEEPSEEK_API_KEY=${DEEPSEEK_API_KEY:-}
      - MOONSHOT_API_KEY=${MOONSHOT_API_KEY:-}
      - CLAUDE_MODEL=${CLAUDE_MODEL:-claude-sonnet-4-5-20250929}
      - AGENT_MAX_TURNS=${AGENT_MAX_TURNS:-60}
      - DEBUG=${DEBUG:-false}
      - TZ=${TZ:-UTC}
      - DATABASE_URL=postgresql+asyncpg://${DB_USER:-skills}:${DB_PASSWORD:-skills123}@db:5432/${DB_NAME:-skills_api}
      # Executor URLs (internal Docker network)
      - EXECUTOR_BASE_URL=http://executor-base:9000
      - EXECUTOR_ML_URL=http://executor-ml:9000
      - EXECUTOR_CUDA_URL=http://executor-cuda:9000
      # Internal paths (inside container)
      - SKILLS_DIR=/app/skills
      - DATA_DIR=/app/data
      - LOGS_DIR=/app/logs
      - UPLOADS_DIR=/app/uploads
      - CONFIG_DIR=/app/config
    volumes:
      # Persist data between container restarts
      - ${SKILLS_PATH:-./volumes/skills}:/app/skills
      - ${LOGS_PATH:-./volumes/logs}:/app/logs
      - ${UPLOADS_PATH:-./volumes/uploads}:/app/uploads
      - ${CONFIG_PATH:-./volumes/config}:/app/config
      # Shared workspaces with executors
      - workspaces:/app/workspaces
      # Environment file for Settings page (docker/.env)
      - ./.env:/app/.env
      # Docker socket for managing executor containers
      - /var/run/docker.sock:/var/run/docker.sock
    ports:
      - "${API_PORT:-8766}:8766"
    depends_on:
      db:
        condition: service_healthy
      executor-base:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8766/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    networks:
      - skills-network

  # ============================================================================
  # Web Service - Next.js Frontend
  # ============================================================================
  web:
    build:
      context: ..
      dockerfile: docker/web/Dockerfile
      args:
        # Note: NEXT_PUBLIC_* are for browser access, so use localhost
        # The rewrites in next.config.js handle server-side proxying
        - NEXT_PUBLIC_API_URL=http://localhost:8766
        - NEXT_PUBLIC_DOCS_URL=http://localhost:${DOCS_PORT:-3001}
    image: skills-web:latest
    container_name: skills-web
    restart: unless-stopped
    environment:
      - NEXT_PUBLIC_API_URL=http://api:8766
      - NEXT_PUBLIC_DOCS_URL=http://localhost:${DOCS_PORT:-3001}
      - TZ=${TZ:-UTC}
    ports:
      - "${WEB_PORT:-626}:3000"
    depends_on:
      api:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    networks:
      - skills-network

  # ============================================================================
  # Docs Service - Docusaurus Documentation
  # ============================================================================
  docs:
    build:
      context: ..
      dockerfile: docker/docs/Dockerfile
    image: skills-docs:latest
    container_name: skills-docs
    restart: unless-stopped
    environment:
      - TZ=${TZ:-UTC}
    ports:
      - "${DOCS_PORT:-3001}:3000"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    networks:
      - skills-network

  # ============================================================================
  # Nginx - Reverse Proxy (Optional, use --profile nginx)
  # ============================================================================
  nginx:
    image: nginx:alpine
    container_name: skills-nginx
    restart: unless-stopped
    profiles:
      - nginx
    ports:
      - "${NGINX_PORT:-80}:80"
      - "${NGINX_SSL_PORT:-443}:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/ssl:/etc/nginx/ssl:ro
    depends_on:
      - api
      - web
    networks:
      - skills-network

  # ============================================================================
  # Executor Services - Code Execution Containers
  # ============================================================================
  # These services provide isolated execution environments for Agent code.
  # executor-base is always started, others are available via profiles.
  #
  # Usage:
  #   docker compose up -d                    # Start with base executor only
  #   docker compose --profile ml up -d       # Include ML executor
  #   docker compose --profile gpu up -d      # Include GPU executor
  # ============================================================================

  executor-base:
    build:
      context: ./executor
      dockerfile: Dockerfile.base
    image: skills-executor:base
    container_name: skills-executor-base
    restart: unless-stopped
    volumes:
      - workspaces:/app/workspaces
      - ${SKILLS_PATH:-./volumes/skills}:/app/skills:ro
    environment:
      - EXECUTOR_NAME=base
      - TZ=${TZ:-UTC}
    networks:
      - skills-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    deploy:
      resources:
        limits:
          memory: 2G

  executor-ml:
    build:
      context: ./executor
      dockerfile: Dockerfile.ml
    image: skills-executor:ml
    container_name: skills-executor-ml
    restart: unless-stopped
    profiles:
      - ml
    volumes:
      - workspaces:/app/workspaces
      - ${SKILLS_PATH:-./volumes/skills}:/app/skills:ro
    environment:
      - EXECUTOR_NAME=ml
      - TZ=${TZ:-UTC}
    networks:
      - skills-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    deploy:
      resources:
        limits:
          memory: 8G

  executor-cuda:
    build:
      context: ./executor
      dockerfile: Dockerfile.cuda
    image: skills-executor:cuda
    container_name: skills-executor-cuda
    restart: unless-stopped
    profiles:
      - gpu
    volumes:
      - workspaces:/app/workspaces
      - ${SKILLS_PATH:-./volumes/skills}:/app/skills:ro
    environment:
      - EXECUTOR_NAME=cuda
      - TZ=${TZ:-UTC}
      - NVIDIA_VISIBLE_DEVICES=all
    networks:
      - skills-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    deploy:
      resources:
        limits:
          memory: 16G
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]

  # Custom executor example - Data Analysis
  executor-data-analysis:
    build:
      context: ./executor
      dockerfile: Dockerfile.data-analysis
    image: skills-executor:data-analysis
    container_name: skills-executor-data-analysis
    restart: unless-stopped
    profiles:
      - data-analysis
    volumes:
      - workspaces:/app/workspaces
      - ${SKILLS_PATH:-./volumes/skills}:/app/skills:ro
    environment:
      - EXECUTOR_NAME=data-analysis
      - TZ=${TZ:-UTC}
    networks:
      - skills-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    deploy:
      resources:
        limits:
          memory: 4G


networks:
  skills-network:
    driver: bridge

volumes:
  workspaces:
    driver: local

# ==============================================================================
# Volume Notes:
# ==============================================================================
# The following directories are mounted from host:
#
# volumes/db/       - PostgreSQL data directory
#                     Created automatically by the db container
#
# volumes/skills/   - Your skill definitions (SKILL.md, scripts/, etc.)
#                     Pre-populated with system skills on first run
#
# volumes/logs/     - Agent execution logs (JSON format)
#                     Created automatically
#
# volumes/uploads/  - User uploaded files
#                     Created automatically
#
# volumes/config/   - Configuration files (mcp.json)
#                     Pre-populated with default config on first run
# ==============================================================================
